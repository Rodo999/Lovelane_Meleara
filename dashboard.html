<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard — Lovelane Meleara</title>
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="icon" href="imagenes/logo.png" />
</head>
<body>
  <header class="navbar">
    <div class="container navbar__inner">
      <a href="index.html" class="brand"><img class="brand__img" src="imagenes/logo.png" alt="Lovelane Meleara" /><span>Lovelane Meleara</span></a>
      <nav class="nav"></nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container">
        <h1 class="section-title">Dashboard de Pedidos</h1>
        <p class="section-subtitle">Administradores con Supabase Auth (RLS)</p>
        <hr class="hr-accent" />

        <!-- Autenticación Supabase -->
        <div class="estimator">
          <h3 class="m-0">Autenticación</h3>
          <div class="form-row">
            <div>
              <label class="label">Email</label>
              <input class="input" id="authEmail" type="email" placeholder="admin@dominio.com" />
            </div>
            <div>
              <label class="label">Contraseña</label>
              <input class="input" id="authPassword" type="password" placeholder="••••••••" />
            </div>
          </div>
          <div class="flex">
            <button class="btn btn--primary" id="btnSignIn">Iniciar sesión</button>
            <button class="btn btn--ghost" id="btnSignUp">Crear cuenta</button>
            <button class="btn btn--gold" id="btnSignOut">Cerrar sesión</button>
          </div>
          <p class="help m-0" id="authInfo">Sin sesión</p>
          <p class="help m-0" id="adminInfo">Admin: N/D</p>
        </div>

        <!-- Filtros y acciones -->
        <div class="estimator mt-24">
          <div class="form-row">
            <div>
              <label class="label">Filtros</label>
              <div class="flex flex-wrap">
                <input class="input" id="fSearch" placeholder="Buscar email contiene..." />
                <input class="input" id="fEmail" placeholder="Email exacto" />
                <select class="select" id="fStatus">
                  <option value="">-- Status --</option>
                  <option value="paid">paid</option>
                  <option value="unpaid">unpaid</option>
                </select>
                <input class="input" id="fStart" type="datetime-local" />
                <input class="input" id="fEnd" type="datetime-local" />
                <input class="input" id="fLimit" type="number" min="1" max="200" value="50" />
                <select class="select" id="fOrderBy">
                  <option value="created_at">created_at</option>
                  <option value="amount_total">amount_total</option>
                  <option value="customer_email">customer_email</option>
                  <option value="status">status</option>
                </select>
                <select class="select" id="fOrderDir">
                  <option value="desc">desc</option>
                  <option value="asc">asc</option>
                </select>
                <button class="btn btn--primary" id="btnLoad">Cargar</button>
                <button class="btn btn--ghost" id="btnNext">Siguiente</button>
                <button class="btn btn--ghost" id="btnPrev">Anterior</button>
                <button class="btn btn--gold" id="btnCSV">Exportar CSV</button>
                <button class="btn btn--ghost" id="btnJSON">Exportar JSON</button>
                <button class="btn btn--ghost" id="btnToday">Hoy</button>
                <button class="btn btn--ghost" id="btnWeek">Esta semana</button>
                <button class="btn btn--ghost" id="btnMonth">Este mes</button>
                <button class="btn btn--ghost" id="btnClearDates">Limpiar fechas</button>
                <label class="chip"><input type="checkbox" id="autoRefresh" /> Auto-refresco (30s)</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Gestión de administradores -->
        <div class="estimator mt-24" id="adminsBox" style="display:none;">
          <h3 class="m-0">Gestión de administradores</h3>
          <div class="form-row">
            <div>
              <label class="label" for="newAdminEmail">Nuevo admin (email)</label>
              <input class="input" id="newAdminEmail" placeholder="correo@dominio.com" />
              <button class="btn btn--gold" id="btnAddAdmin">Agregar</button>
            </div>
            <div>
              <label class="label">Admins actuales</label>
              <div id="adminsList" class="chips"></div>
              <button class="btn btn--ghost" id="btnReloadAdmins">Recargar</button>
            </div>
          </div>
        </div>

        <!-- Tabla de pedidos -->
        <div class="mt-24" style="overflow-x:auto;">
          <div class="alert mb-12" id="summary" style="display:none"></div>
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Session</th>
                <th>Email</th>
                <th>Status</th>
                <th>Monto</th>
                <th>Moneda</th>
                <th>Items</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <!-- Modal simple -->
        <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;">
          <div style="background:#fff; margin:10vh auto; padding:16px; width:min(900px,92%); border-radius:14px;">
            <div class="flex justify-between items-center mb-12">
              <h3 class="m-0">Detalle de pedido</h3>
              <button class="btn btn--ghost" id="modalClose">Cerrar</button>
            </div>
            <pre id="modalBody" style="white-space:pre-wrap; max-height:60vh; overflow:auto;"></pre>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer"></footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/app.js"></script>
  <script>
    // Cargar config pública desde función serverless (evita secretos en repo)
    let supa;
    async function initSupabase(){
      const res = await fetch('/.netlify/functions/public-env');
      if (!res.ok) { alert('No se pudo cargar configuración pública'); return; }
      const { supabaseUrl, supabaseAnonKey } = await res.json();
      if (!supabaseUrl || !supabaseAnonKey) { alert('Faltan variables públicas en Netlify'); return; }
      supa = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
      await refreshAuth();
      supa.auth.onAuthStateChange((_e,_s)=>{ refreshAuth(); });
    }

    let offset = 0;
    let autoTimer = null;
    let currentUser = null;
    let isAdmin = false;

    function money(v, c){ try{ return new Intl.NumberFormat('es-MX', { style: 'currency', currency: (c||'MXN').toUpperCase() }).format((v||0)/100); }catch{ return v; } }
    function toISO(dt){ if(!dt) return ''; const d = new Date(dt); return d.toISOString(); }

    async function refreshAuth() {
      const { data: { user } } = await supa.auth.getUser();
      currentUser = user;
      document.getElementById('authInfo').textContent = user ? `Sesión: ${user.email}` : 'Sin sesión';
      if (!user) {
        isAdmin = false;
        document.getElementById('adminInfo').textContent = 'Admin: N/D';
        document.getElementById('adminsBox').style.display = 'none';
        return;
      }
      // Verificar admin por RLS
      const { data, error } = await supa.from('admins').select('email').eq('email', user.email).limit(1);
      isAdmin = !!(data && data.length);
      document.getElementById('adminInfo').textContent = `Admin: ${isAdmin ? 'Sí' : 'No'}`;
      document.getElementById('adminsBox').style.display = isAdmin ? '' : 'none';
    }

    // Auth handlers
    document.getElementById('btnSignIn').addEventListener('click', async ()=>{
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      const { error } = await supa.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);
      await refreshAuth();
    });
    document.getElementById('btnSignUp').addEventListener('click', async ()=>{
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      const redirectTo = window.location.origin + '/dashboard.html';
      const { error } = await supa.auth.signUp({ email, password, options: { emailRedirectTo: redirectTo } });
      if (error) return alert(error.message);
      alert('Cuenta creada. Revisa tu correo y usa el enlace de verificación. Serás redirigido a: '+redirectTo);
    });
    document.getElementById('btnSignOut').addEventListener('click', async ()=>{
      await supa.auth.signOut();
      await refreshAuth();
    });

    function buildFilters(){
      return {
        search: document.getElementById('fSearch').value.trim(),
        email: document.getElementById('fEmail').value.trim(),
        status: document.getElementById('fStatus').value.trim(),
        start: document.getElementById('fStart').value,
        end: document.getElementById('fEnd').value,
        limit: Math.min(200, Math.max(1, Number(document.getElementById('fLimit').value || 50))),
        orderBy: document.getElementById('fOrderBy').value,
        orderDir: document.getElementById('fOrderDir').value
      };
    }

    async function loadOrders(){
      if (!currentUser) { alert('Inicia sesión'); return; }
      // Construir query con RLS (admins ven todo; clientes solo los suyos)
      const f = buildFilters();
      let q = supa.from('orders').select('*').order(f.orderBy, { ascending: f.orderDir === 'asc' }).range(offset, offset + f.limit - 1);
      if (f.email) q = q.eq('customer_email', f.email);
      if (f.search) q = q.ilike('customer_email', `%${f.search}%`);
      if (f.status) q = q.eq('status', f.status);
      if (f.start) q = q.gte('created_at', toISO(f.start));
      if (f.end) q = q.lte('created_at', toISO(f.end));

      const { data, error } = await q;
      if (error) { alert(error.message); return; }

      const tbody = document.getElementById('rows');
      const summary = document.getElementById('summary');
      tbody.innerHTML = '';
      let total = 0;
      (data||[]).forEach(r => {
        total += (r.amount_total||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${r.session_id}</td>
          <td>${r.customer_email||''}</td>
          <td>${r.status||''}</td>
          <td>${money(r.amount_total, r.currency)}</td>
          <td>${(r.currency||'').toUpperCase()}</td>
          <td><pre style="white-space:pre-wrap;">${JSON.stringify(r.items||[], null, 2)}</pre></td>
          <td>
            <div class="flex">
              <button class="btn btn--ghost" data-act="view" data-id="${r.session_id}">Ver</button>
              ${isAdmin ? `<button class="btn btn--primary" data-act="mark-paid" data-id="${r.session_id}">Marcar pagado</button>`:''}
              ${isAdmin ? `<button class="btn btn--gold" data-act="add-note" data-id="${r.session_id}">Añadir nota</button>`:''}
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
      summary.style.display = '';
      summary.textContent = `Registros: ${(data||[]).length} | Total: ${money(total, 'MXN')}`;

      // Acciones
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        btn.addEventListener('click', async ()=>{
          if (act === 'view') {
            document.getElementById('modalBody').textContent = JSON.stringify((data||[]).find(x=>x.session_id===id)||{}, null, 2);
            document.getElementById('modal').style.display = '';
          }
          if (act === 'mark-paid') {
            await updateOrderAuth(id, { status: 'paid' });
          }
          if (act === 'add-note') {
            const note = prompt('Escribe una nota para este pedido:');
            if (note) await updateOrderAuth(id, { note });
          }
        });
      });
    }

    // Exportaciones
    document.getElementById('btnJSON').addEventListener('click', async ()=>{
      const f = buildFilters();
      let q = supa.from('orders').select('*').order(f.orderBy, { ascending: f.orderDir === 'asc' }).range(offset, offset + f.limit - 1);
      if (f.email) q = q.eq('customer_email', f.email);
      if (f.search) q = q.ilike('customer_email', `%${f.search}%`);
      if (f.status) q = q.eq('status', f.status);
      if (f.start) q = q.gte('created_at', toISO(f.start));
      if (f.end) q = q.lte('created_at', toISO(f.end));
      const { data, error } = await q;
      if (error) return alert(error.message);
      const blob = new Blob([JSON.stringify(data||[], null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pedidos.json'; a.click();
    });
    document.getElementById('btnCSV').addEventListener('click', async ()=>{
      const f = buildFilters();
      let q = supa.from('orders').select('*').order(f.orderBy, { ascending: f.orderDir === 'asc' }).range(offset, offset + f.limit - 1);
      if (f.email) q = q.eq('customer_email', f.email);
      if (f.search) q = q.ilike('customer_email', `%${f.search}%`);
      if (f.status) q = q.eq('status', f.status);
      if (f.start) q = q.gte('created_at', toISO(f.start));
      if (f.end) q = q.lte('created_at', toISO(f.end));
      const { data, error } = await q;
      if (error) return alert(error.message);
      const headers = ['created_at','session_id','customer_email','status','amount_total','currency'];
      const lines = [headers.join(',')];
      (data||[]).forEach(r=>{
        lines.push([
          new Date(r.created_at).toISOString(), r.session_id, r.customer_email||'', r.status||'', (r.amount_total||0)/100, (r.currency||'').toUpperCase()
        ].map(v=>`"${String(v).replaceAll('"','""')}"`).join(','));
      });
      const csv = lines.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pedidos.csv'; a.click();
    });

    // Admins via endpoint con Auth
    async function listAdmins(){
      const sess = await supa.auth.getSession();
      const token = sess.data.session?.access_token;
      if (!token) return alert('Sin sesión');
      const res = await fetch('/.netlify/functions/admins-auth', { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      const wrap = document.getElementById('adminsList'); wrap.innerHTML = '';
      if (!res.ok) { wrap.textContent = 'Error al cargar admins'; return; }
      data.forEach(a => {
        const chip = document.createElement('span'); chip.className = 'chip'; chip.textContent = a.email;
        const del = document.createElement('button'); del.className = 'btn btn--ghost'; del.textContent = 'Eliminar'; del.style.marginLeft = '8px';
        del.addEventListener('click', async ()=>{ if (!confirm('¿Eliminar admin '+a.email+'?')) return; await deleteAdmin(a.email); });
        const holder = document.createElement('span'); holder.appendChild(chip); holder.appendChild(del); wrap.appendChild(holder);
      });
    }
    async function addAdmin(){
      const email = document.getElementById('newAdminEmail').value.trim(); if (!email) return alert('Ingresa un email');
      const sess = await supa.auth.getSession(); const token = sess.data.session?.access_token; if (!token) return alert('Sin sesión');
      const res = await fetch('/.netlify/functions/admins-auth', { method:'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
      if (!res.ok) { const t = await res.text(); return alert('Error: '+t); }
      document.getElementById('newAdminEmail').value = ''; listAdmins();
    }
    async function deleteAdmin(email){
      const sess = await supa.auth.getSession(); const token = sess.data.session?.access_token; if (!token) return alert('Sin sesión');
      const res = await fetch('/.netlify/functions/admins-auth?email='+encodeURIComponent(email), { method:'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
      if (!res.ok) { const t = await res.text(); return alert('Error: '+t); }
      listAdmins();
    }

    async function updateOrderAuth(session_id, patch){
      const sess = await supa.auth.getSession(); const token = sess.data.session?.access_token; if (!token) return alert('Sin sesión');
      const res = await fetch('/.netlify/functions/update-order-auth', { method:'PATCH', headers:{ 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id, ...patch }) });
      if (!res.ok) { const t = await res.text(); return alert('Error: '+t); }
      loadOrders();
    }

    // Eventos UI
    document.getElementById('btnLoad').addEventListener('click', ()=>{ offset=0; loadOrders(); if(isAdmin) listAdmins(); });
    document.getElementById('btnNext').addEventListener('click', ()=>{ const lim = buildFilters().limit; offset += lim; loadOrders(); });
    document.getElementById('btnPrev').addEventListener('click', ()=>{ const lim = buildFilters().limit; offset = Math.max(0, offset - lim); loadOrders(); });
    // Rango rápido
    function fmtLocal(dt){
      const pad = n => String(n).padStart(2,'0');
      const y = dt.getFullYear(); const m = pad(dt.getMonth()+1); const d = pad(dt.getDate());
      const h = pad(dt.getHours()); const mi = pad(dt.getMinutes());
      return `${y}-${m}-${d}T${h}:${mi}`;
    }
    document.getElementById('btnToday').addEventListener('click', ()=>{
      const now = new Date();
      const start = new Date(now); start.setHours(0,0,0,0);
      const end = new Date(now); end.setHours(23,59,59,999);
      document.getElementById('fStart').value = fmtLocal(start);
      document.getElementById('fEnd').value = fmtLocal(end);
      offset=0; loadOrders();
    });
    document.getElementById('btnWeek').addEventListener('click', ()=>{
      const now = new Date();
      const day = now.getDay(); // 0=Domingo
      const diffToMonday = (day === 0 ? -6 : 1 - day);
      const start = new Date(now); start.setDate(now.getDate()+diffToMonday); start.setHours(0,0,0,0);
      document.getElementById('fStart').value = fmtLocal(start);
      document.getElementById('fEnd').value = fmtLocal(now);
      offset=0; loadOrders();
    });
    document.getElementById('btnMonth').addEventListener('click', ()=>{
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
      document.getElementById('fStart').value = fmtLocal(start);
      document.getElementById('fEnd').value = fmtLocal(new Date());
      offset=0; loadOrders();
    });
    document.getElementById('btnClearDates').addEventListener('click', ()=>{
      document.getElementById('fStart').value = '';
      document.getElementById('fEnd').value = '';
      offset=0; loadOrders();
    });

    document.getElementById('btnAddAdmin').addEventListener('click', addAdmin);
    document.getElementById('btnReloadAdmins').addEventListener('click', listAdmins);
    document.getElementById('modalClose').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none'; });
    document.getElementById('autoRefresh').addEventListener('change', (e)=>{ if(e.target.checked){ autoTimer=setInterval(loadOrders,30000);} else {clearInterval(autoTimer); autoTimer=null;} });

    // Init
    (async ()=>{ await initSupabase(); })();
  </script>
</body>
</html>
