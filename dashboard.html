<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard — Lovelane Meleara</title>
  <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
  <header class="navbar">
    <div class="container navbar__inner">
      <a href="index.html" class="brand"><img class="brand__img" src="imagenes/logo.png" alt="Lovelane Meleara" /><span>Lovelane Meleara</span></a>
      <nav class="nav"></nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container">
        <h1 class="section-title">Dashboard de Pedidos</h1>
        <p class="section-subtitle">Solo administradores. Protegido por token.</p>
        <hr class="hr-accent" />

        <div class="estimator">
          <div class="form-row">
            <div>
              <label class="label" for="token">Token de administrador</label>
              <input class="input" id="token" placeholder="Ingresa tu token" />
              <p class="help">Configura ADMIN_DASH_TOKEN en Netlify y pégalo aquí.</p>
            </div>
            <div>
              <label class="label">Filtros</label>
              <div class="flex flex-wrap">
                <input class="input" id="fSearch" placeholder="Buscar email contiene..." />
                <input class="input" id="fEmail" placeholder="Email exacto" />
                <select class="select" id="fStatus">
                  <option value="">-- Status --</option>
                  <option value="paid">paid</option>
                  <option value="unpaid">unpaid</option>
                </select>
                <input class="input" id="fStart" type="datetime-local" />
                <input class="input" id="fEnd" type="datetime-local" />
                <input class="input" id="fLimit" type="number" min="1" max="200" value="50" />
                <select class="select" id="fOrderBy">
                  <option value="created_at">created_at</option>
                  <option value="amount_total">amount_total</option>
                  <option value="customer_email">customer_email</option>
                  <option value="status">status</option>
                </select>
                <select class="select" id="fOrderDir">
                  <option value="desc">desc</option>
                  <option value="asc">asc</option>
                </select>
                <button class="btn btn--primary" id="btnLoad">Cargar</button>
                <button class="btn btn--ghost" id="btnNext">Siguiente</button>
                <button class="btn btn--ghost" id="btnPrev">Anterior</button>
                <button class="btn btn--gold" id="btnCSV">Exportar CSV</button>
                <button class="btn btn--ghost" id="btnJSON">Exportar JSON</button>
                <label class="chip"><input type="checkbox" id="autoRefresh" /> Auto-refresco (30s)</label>
              </div>
            </div>
          </div>
        </div>

        <div class="estimator mt-24">
          <h3 class="m-0">Gestión de administradores</h3>
          <div class="form-row">
            <div>
              <label class="label" for="newAdminEmail">Nuevo admin (email)</label>
              <input class="input" id="newAdminEmail" placeholder="correo@dominio.com" />
              <button class="btn btn--gold" id="btnAddAdmin">Agregar</button>
            </div>
            <div>
              <label class="label">Admins actuales</label>
              <div id="adminsList" class="chips"></div>
              <button class="btn btn--ghost" id="btnReloadAdmins">Recargar</button>
            </div>
          </div>
        </div>

        <div class="mt-24" style="overflow-x:auto;">
          <div class="alert mb-12" id="summary" style="display:none"></div>
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Session</th>
                <th>Email</th>
                <th>Status</th>
                <th>Monto</th>
                <th>Moneda</th>
                <th>Items</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <!-- Modal simple -->
        <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;">
          <div style="background:#fff; margin:10vh auto; padding:16px; width:min(900px,92%); border-radius:14px;">
            <div class="flex justify-between items-center mb-12">
              <h3 class="m-0">Detalle de pedido</h3>
              <button class="btn btn--ghost" id="modalClose">Cerrar</button>
            </div>
            <pre id="modalBody" style="white-space:pre-wrap; max-height:60vh; overflow:auto;"></pre>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer"></footer>

  <script src="assets/js/app.js"></script>
  <script>
    function money(v, c){ try{ return new Intl.NumberFormat('es-MX', { style: 'currency', currency: (c||'MXN').toUpperCase() }).format((v||0)/100); }catch{ return v; } }
    function toISO(dt){ if(!dt) return ''; const d = new Date(dt); return d.toISOString(); }

    async function listAdmins(){
      const token = document.getElementById('token').value.trim();
      const res = await fetch('/.netlify/functions/admins', { headers: { 'x-admin-token': token } });
      const data = await res.json();
      const wrap = document.getElementById('adminsList');
      wrap.innerHTML = '';
      if (!res.ok) { wrap.textContent = 'Error al cargar admins'; return; }
      data.forEach(a => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = a.email;
        const del = document.createElement('button');
        del.className = 'btn btn--ghost';
        del.textContent = 'Eliminar';
        del.style.marginLeft = '8px';
        del.addEventListener('click', async ()=>{
          if (!confirm('¿Eliminar admin '+a.email+'?')) return;
          const r = await fetch('/.netlify/functions/admins?email='+encodeURIComponent(a.email), { method: 'DELETE', headers: { 'x-admin-token': token } });
          if (!r.ok) { alert('No se pudo eliminar'); return; }
          listAdmins();
        });
        const holder = document.createElement('span');
        holder.appendChild(chip);
        holder.appendChild(del);
        wrap.appendChild(holder);
      });
    }

    async function addAdmin(){
      const token = document.getElementById('token').value.trim();
      const email = document.getElementById('newAdminEmail').value.trim();
      if (!email) { alert('Ingresa un email'); return; }
      const res = await fetch('/.netlify/functions/admins', {
        method: 'POST', headers: { 'x-admin-token': token, 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
      });
      if (!res.ok) { const t = await res.text(); alert('Error: '+t); return; }
      document.getElementById('newAdminEmail').value = '';
      listAdmins();
    }

    let offset = 0;
    let autoTimer = null;

    function buildQS(){
      const qs = new URLSearchParams();
      const fSearch = document.getElementById('fSearch').value.trim();
      const fEmail = document.getElementById('fEmail').value.trim();
      const fStatus = document.getElementById('fStatus').value.trim();
      const fStart = document.getElementById('fStart').value;
      const fEnd = document.getElementById('fEnd').value;
      const fLimit = Math.min(200, Math.max(1, Number(document.getElementById('fLimit').value || 50)));
      const orderBy = document.getElementById('fOrderBy').value;
      const orderDir = document.getElementById('fOrderDir').value;
      qs.set('limit', String(fLimit));
      qs.set('offset', String(offset));
      qs.set('order_by', orderBy);
      qs.set('order_dir', orderDir);
      if (fEmail) qs.set('email', fEmail);
      if (fSearch) qs.set('search', fSearch);
      if (fStatus) qs.set('status', fStatus);
      if (fStart) qs.set('start', toISO(fStart));
      if (fEnd) qs.set('end', toISO(fEnd));
      return qs;
    }

    function toCSV(rows){
      const headers = ['created_at','session_id','customer_email','status','amount_total','currency'];
      const lines = [headers.join(',')];
      rows.forEach(r=>{
        lines.push([
          new Date(r.created_at).toISOString(),
          r.session_id,
          r.customer_email||'',
          r.status||'',
          (r.amount_total||0)/100,
          (r.currency||'').toUpperCase(),
        ].map(v=>`"${String(v).replaceAll('"','""')}"`).join(','));
      });
      return lines.join('\n');
    }

    async function loadOrders(){
      const token = document.getElementById('token').value.trim();
      const qs = buildQS();
      const res = await fetch('/.netlify/functions/list-orders?'+qs.toString(), { headers: { 'x-admin-token': token } });
      const data = await res.json();
      if (!res.ok) { alert('Error: '+(data.error || JSON.stringify(data))); return; }
      const tbody = document.getElementById('rows');
      const summary = document.getElementById('summary');
      tbody.innerHTML = '';
      let total = 0;
      data.forEach(r => {
        total += (r.amount_total||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${r.session_id}</td>
          <td>${r.customer_email||''}</td>
          <td>${r.status||''}</td>
          <td>${money(r.amount_total, r.currency)}</td>
          <td>${(r.currency||'').toUpperCase()}</td>
          <td><pre style="white-space:pre-wrap;">${JSON.stringify(r.items||[], null, 2)}</pre></td>
          <td>
            <div class="flex">
              <button class="btn btn--ghost" data-act="view" data-id="${r.session_id}">Ver</button>
              <button class="btn btn--primary" data-act="mark-paid" data-id="${r.session_id}">Marcar pagado</button>
              <button class="btn btn--gold" data-act="add-note" data-id="${r.session_id}">Añadir nota</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      // Acciones
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        btn.addEventListener('click', async ()=>{
          if (act === 'view') {
            document.getElementById('modalBody').textContent = JSON.stringify(data.find(x=>x.session_id===id)||{}, null, 2);
            document.getElementById('modal').style.display = '';
          }
          if (act === 'mark-paid') {
            await updateOrder(id, { status: 'paid' });
          }
          if (act === 'add-note') {
            const note = prompt('Escribe una nota para este pedido:');
            if (note) await updateOrder(id, { note });
          }
        });
      });
      summary.style.display = '';
      summary.textContent = `Registros: ${data.length} | Total: ${money(total, 'MXN')}`;
    }

    document.getElementById('btnLoad').addEventListener('click', ()=>{ offset=0; loadOrders(); listAdmins(); });
    document.getElementById('btnReloadAdmins').addEventListener('click', listAdmins);
    document.getElementById('btnAddAdmin').addEventListener('click', addAdmin);
    document.getElementById('btnNext').addEventListener('click', ()=>{ offset += Math.min(200, Math.max(1, Number(document.getElementById('fLimit').value||50))); loadOrders(); });
    document.getElementById('btnPrev').addEventListener('click', ()=>{ offset = Math.max(0, offset - Math.min(200, Math.max(1, Number(document.getElementById('fLimit').value||50)))); loadOrders(); });
    document.getElementById('btnJSON').addEventListener('click', async ()=>{
      const token = document.getElementById('token').value.trim();
      const qs = buildQS();
      const res = await fetch('/.netlify/functions/list-orders?'+qs.toString(), { headers: { 'x-admin-token': token } });
      const data = await res.json();
      if (!res.ok) { alert('Error: '+(data.error || JSON.stringify(data))); return; }
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'pedidos.json';
      a.click();
    });

    document.getElementById('btnCSV').addEventListener('click', async ()=>{
      const token = document.getElementById('token').value.trim();
      const qs = buildQS();
      const res = await fetch('/.netlify/functions/list-orders?'+qs.toString(), { headers: { 'x-admin-token': token } });
      const data = await res.json();
      if (!res.ok) { alert('Error: '+(data.error || JSON.stringify(data))); return; }
      const csv = toCSV(data);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'pedidos.csv';
      a.click();
    });
  async function updateOrder(session_id, patch){
      const token = document.getElementById('token').value.trim();
      const res = await fetch('/.netlify/functions/update-order', {
        method: 'PATCH', headers: { 'x-admin-token': token, 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id, ...patch })
      });
      if (!res.ok) { const t = await res.text(); alert('Error: '+t); return; }
      loadOrders();
    }

    // Modal
    document.getElementById('modalClose').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none'; });

    // Auto refresco
    document.getElementById('autoRefresh').addEventListener('change', (e)=>{
      if (e.target.checked) {
        autoTimer = setInterval(loadOrders, 30000);
      } else {
        clearInterval(autoTimer); autoTimer = null;
      }
    });
  </script>
</body>
</html>
